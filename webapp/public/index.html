<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lightning Superchat</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        #qrcode img {
            margin: 0 auto;
            display: block;
        }
    </style>
</head>
<body>
    <h1>Lightning Superchat</h1>
    <form id="invoice-form">
        <label for="amount">Amount (sats):</label>
        <input type="number" id="amount" required>
        <label for="message">Message:</label>
        <input type="text" id="message" required>
        <button type="submit">Create Invoice</button>
    </form>
    <div id="invoice-container" style="display: none;">
        <h2>Invoice Created</h2>
        <p>Please pay this invoice using a Lightning wallet on testnet:</p>
        <div id="qrcode"></div>
        <p>Or click this link to pay: <a id="payment-link" href="#" target="_blank">Pay with Lightning</a></p>
        <p>Invoice: <span id="invoice"></span></p>
        <p id="payment-status">Waiting for payment...</p>
    </div>
    <script>
        const form = document.getElementById('invoice-form');
        const invoiceContainer = document.getElementById('invoice-container');
        let invoiceId;

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = document.getElementById('message').value;
            const amount = document.getElementById('amount').value;
            try {
                const response = await fetch('/create-invoice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, amount: parseInt(amount) }),
                });
                const data = await response.json();
                if (data.invoice) {
                    document.getElementById('invoice').textContent = data.invoice;
                    document.getElementById('invoice-container').style.display = 'block';
                    document.getElementById('payment-link').href = `lightning:${data.invoice}`;
                    QRCode.toCanvas(document.getElementById('qrcode'), data.invoice, function (error) {
                        if (error) console.error(error);
                        console.log('QR code generated!');
                    });
                    invoiceId = data.invoiceId;
                    checkPaymentStatus();
                } else {
                    alert('Error creating invoice: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error creating invoice');
            }
        });

        async function checkPaymentStatus() {
            try {
                const response = await fetch(`/check-invoice/${invoiceId}`);
                const data = await response.json();
                if (data.paid) {
                    document.getElementById('payment-status').textContent = 'Payment received!';
                } else {
                    setTimeout(checkPaymentStatus, 5000);
                }
            } catch (error) {
                console.error('Error checking payment status:', error);
            }
        }
    </script>
</body>
</html>